import cv2
import numpy as np
import tensorflow as tf
from collections import deque

# Load trained models
eye_model = tf.keras.models.load_model("Stressdetector/models/eye_state_model.keras")
yawn_model = tf.keras.models.load_model("Stressdetector/models/yawn_model.keras")

IMG_SIZE = 128

# Temporal parameters
WINDOW_SIZE = 20
EYE_CLOSED_THRESHOLD = 0.6   # probability
YAWN_THRESHOLD = 0.6

EYE_RATIO_LIMIT = 0.6        # 60% closed frames
YAWN_RATIO_LIMIT = 0.3       # 30% yawning frames

eye_buffer = deque(maxlen=WINDOW_SIZE)
yawn_buffer = deque(maxlen=WINDOW_SIZE)

cap = cv2.VideoCapture(0)

print("Press ESC to exit")

while True:
    ret, frame = cap.read()
    if not ret:
        break

    frame = cv2.flip(frame, 1)

    # Preprocess
    img = cv2.resize(frame, (IMG_SIZE, IMG_SIZE))
    img = img / 255.0
    img = np.expand_dims(img, axis=0)

    # CNN predictions
    eye_prob = eye_model.predict(img, verbose=0)[0][0]
    yawn_prob = yawn_model.predict(img, verbose=0)[0][0]

    # Convert probabilities to events
    eye_closed = eye_prob < EYE_CLOSED_THRESHOLD
    yawning = yawn_prob > YAWN_THRESHOLD

    eye_buffer.append(eye_closed)
    yawn_buffer.append(yawning)

    micro_drowsy = False

    if len(eye_buffer) == WINDOW_SIZE:
        eye_ratio = sum(eye_buffer) / WINDOW_SIZE
        yawn_ratio = sum(yawn_buffer) / WINDOW_SIZE

        if eye_ratio >= EYE_RATIO_LIMIT or yawn_ratio >= YAWN_RATIO_LIMIT:
            micro_drowsy = True

    # Display info
    cv2.putText(frame, f"Eye closed prob: {1-eye_prob:.2f}",
                (20, 40), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (255,255,0), 2)

    cv2.putText(frame, f"Yawn prob: {yawn_prob:.2f}",
                (20, 70), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (255,255,0), 2)

    if micro_drowsy:
        cv2.putText(frame, "MICRO-DROWSINESS DETECTED",
                    (30, 120), cv2.FONT_HERSHEY_SIMPLEX,
                    1, (0,0,255), 3)
    else:
        cv2.putText(frame, "STATUS: ALERT",
                    (30, 120), cv2.FONT_HERSHEY_SIMPLEX,
                    1, (0,255,0), 3)

    cv2.imshow("Real-Time Micro-Drowsiness Detection", frame)

    if cv2.waitKey(1) & 0xFF == 27:
        break

cap.release()
cv2.destroyAllWindows()
